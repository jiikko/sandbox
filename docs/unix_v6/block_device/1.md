# でロックデバイスサブシステム
## デバイスの種類
* ブロックデバイス
   * 処理単位はブロック単位
   * 高速
   * 先頭ブロックから順に0, 1, 2...とアドレスが振られている
   * 大量データ転送に向いている
     * カーネルのバッファの使用により、キャッシュ、非同期操作、遅延書き込みなどをサポートする
     * ブロックでバイス上にファイルシステムが構築される
   * ディスクデバイス
* キャラクタデバイス
  * 処理端は文字
  * アドレスは振られてなくてデータは使い捨て
  * キューの先頭からしかアクセスできない(シーケンシャルアクセス)
  * 低速
  * 少量データ転送に向いている
  * ラインプリンタ、制御端末

# デバイスドライバ
* デバイスドライバは、デバイスの操作を行うプログラム
  * 1デバイスに対して、1デバイスドライバがあることが普通
* デバイスドライバは、デバイスドライバテーブルで管理されてる

# クラスとデバイス番号

# スペシャルファイル
* あるデバイスを使用するためには、そのデバイスに対応するスペシャルファイルを作成する必要があります。
  * システムの管理者がユーザプログラムの/etc/mknodを実行して、スペシャルファイルを作成します。
  * スペシャルファイルにはデバイスのクラスとデバイス番号が含まれる
* スペシャルファイルは/devの下に作成し、そのデバイスを表す文字列とマイナー番号を組み合わせた名前にします
  * たとえば/dev/rk0 というようにします
* /etc/mknod が成功すると、指定されたディレクトリにスペシャルファイルが追加され、それに他王したinodeが作成される
  * inodeにはクラスを表すフラグが立ち、inode.i_addr[0]にはデバイス番号が格納される
* そのスペシャルファイルに対して、open, read, write, closeシステムコールが実行することで、
  * システムコールハンドラ内でメジャー番号に対応したデバイスドライバが呼び出され、デバイスの操作が行われる
* ユーザから見ると通常ファイル操作とデバイス操作のインターフェースが共通になっているので、
  * たとえばユーザプログラムの出力をファイルからラインプリンタに変えたいときにはopenする対象を切り替えるだけですむ
  * 通常ファイルとデバイスのインタフェースが統一されているのはUNIX V6特徴

## バッファ
* ブロックデバイスサブシステムは、バッファを用いてブロックデバイスとデータのやりとりを行う
* バッファには、デバイス番号とブロック番号で名前をつける
  * あるブロックに対する操作を行うときには、必要としているバッファすでにないか探し、見つかればそれを使用する
  * 見つからなければ、新たに未割当バッファを取得し、それに名前をつけて使用する
* バッファを用いる目的は、大きく2つある
  * 1つめは、複数のプロセスから同時に同じブロクのアクセスが起きた時に整合性を保つため
  * 2つめは、よく読み書きするブロックのコピーをメモリ中におくことで性能を改善するためです
  * キャッシュをつけってブロックデバイスへのアクセス回数を減らせる
  * ブロックデバイスへのアクセス速度はCPUと比べて遅いのでアクセス回数が減ればシステムの性能改善が見込める
  * 他にも、必要となるデータを裏でさきにバッファに読み込んでおいたり、バッファにデータ満たされてから初めてブロックデバイスにデータを書き込みに行くなどすると性能改善する
* バッファは、buf構造体の配列buf[]で管理されている

## b-list と ac-list
* buf[]はb-listとav-listの二重リンクリストで管理されている
* なぞ
