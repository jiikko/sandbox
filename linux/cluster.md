# クラスタシステムのしくみ
## クラスタパターン
* ノード構成パターン
  * 可用性を高めるフェイルオーバークラスタ
    * 稼働系と待機系を容易しておき、障害が発生したタイミングで切り替える
       * 待機系には、ホットスタンバイとコールドスタンバイがあり、切替時のダウンタイムを短くしたい時はホットスタンバイを用いる。フェイルオーバークラスタを構成するパッケージにkeepalived, Heartbeatがある。
* スループットを高めるロードバランシングクラスタ
  * 待機系は容易せず、障害が発生したサーバを稼働系から外す。
  * LVS(Linux Virtual Server), HAProxy

## クラスタシステムのストレージ構成パターン
クラスタシステムとして動作するためには、すべてのノードが同じデータにアクセスできるようにする必要があります。ストレージはクラスタシステムの中でデータを保存して共有する役割を担います。データを共有する方法はいくつかあります。大井区わけると、一箇所に書き込む方法と複数箇所に分散して書き込む方法に大別されます。
* 共有ディスク方式
  * 1台のストレージをクラスタ内の複数のノードが参照する構成です。シンプルな構成なので運用しやすい一方、ストレージが単一障害点になります。
  * この構成をとる場合、ハードウェアレベルでの冗長設計がされている、1箇所が故障しても停止することなく動作するよう設計されている専用のストレージ装置を使います。
  * NFS, samba
* ミラーリング方式
  * 共有ディスクは使わず、ノード動詞でデータをリアルタイム同期させて共有する構成です。
  * 同じデータを複数箇所に書き込む方法にあたります。あるノードで障害が発生しても別のノードに同じデータが保存されているのため、データへのアクセスが失われることはありません。
  * DRBD(Distributed Replicated Block Device)
* レプリケーション方式
  * ストレージ装置動詞やノード動詞で一定間隔でデータの同期をとる構成です。
  * 一定間隔での差分コピーをとるようにすることで、書き込みのオーバーヘッドを抑えることができます。
  * マスタガワで障害がおき、レプリカにフェイルオーバーするとレプリカ側に反映される前のマスタの書き込みは失われる。
* 分散ストレージ
  * 定められた単位でデータを分割して同時に複数箇所に書き込む。パーティショニング。
  * 分割することにより、複数のノードに分散して高速に書き込むことができる一方、そのうちの居ひとかけらでも破損するとデータを読み出すことができなくなってします。このため、分散ストレージはハードウェア故障などで片方のひとつが破損しても、ほかから同じデータを読み出せるように、2, 3箇所程度に同じデータを複製しておき、データの消失を防ぐ。
  * Riak, Ceph

## クラスタシステムの動作
### フェイルオーバークラスタ
  * マスタ・バックアップ
      * マスタが処理を実行している間、バックアップはマスタを監視して待機します。障害によりマスタが動作を停止した場合、バックアップはそれを検知して自信がマスタに昇格して処理を実行します。
* ハートビート
  * 一定間隔で発信される生存を締める信号
* フェイオーバー
* スプリットブレイン（予期しない動作)
  * ハートビートの通信だけが途切れ、マスタが処理を続けた場合にはスプリットブレインという現象がおきます。
  * ハートビートが途切れるとバックアップノードは、マスタに昇格して処理を引き継ごうとします。このとき、もともとのマスタがまだ処理を継続しているとマスタが2つになり、データの不整合やリソースの奪い合いが生じます。結果としてクラスタとしての動作を継続することができなくなります。
### ロードバランシングクラスタ
* ヘルスチェック
* リバランス

## CAP定理
CAP定理はこれら3つの性質を同時にクラスタに実装することができないことを示しています。たとえば、ミラーリングは一貫性と可用性を実現できていますが、ノード間のデータ連携ができないと機能しないため、分断体制がありません。単一の装置で構成される共有ディスク方式の場合は、分断されないという意味で分断体制がありますが、1ノード構成になるため可用性が満たせません。
* 一貫性(Connsistency)
  * すべてのノードが同じデータを参照できていること
* 可用性(Availability)
  * 一部のノードが障害で停止しても機能すること
* 分断体制(Parition tolerance)
  * ノード動詞連携ができなくなっても機能すること
